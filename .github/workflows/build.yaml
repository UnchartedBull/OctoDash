name: CI

on:
  push:
    branches:
      - main
      - next
  pull_request:
    branches:
      - main
      - next
  workflow_dispatch:
  release:
    types: [published]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Cache node modules
        uses: actions/cache@v4
        env:
          cache-name: node-modules
        with:
          path: '**/node_modules'
          key: octodash-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            octodash-build-${{ env.cache-name }}-
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Install latest npm
        run: sudo npm install -g npm@latest
      - name: Installing Dependencies
        run: npm ci
      - name: Linting Application
        run: npm run lint
      - name: Checking if locale is updated
        run: |-
          npm run locale:extract
          if [ "$(git diff --name-only)" ]; then
            echo ""
            echo "ERROR! Locale file update detected!  Please run 'npm run locale:update'."
            echo ""
            exit 1
          fi

  test-python:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Install Python test dependencies
        run: python -m pip install pytest octoprint --user
      - name: Install package
        run: python -m pip install . --user
      - name: Run Python tests
        run: pytest

  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Cache node modules
        uses: actions/cache@v4
        env:
          cache-name: node-modules
        with:
          path: '**/node_modules'
          key: octodash-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            octodash-build-${{ env.cache-name }}-
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Install latest npm
        run: sudo npm install -g npm@latest
      - name: Installing Dependencies
        run: npm ci
      - name: Building Application
        run: npm run build
      - name: ðŸ— Set up PR environment
        if: github.event_name == 'pull_request'
        run: |
          # use base ref of PR as branch name for versioning
          echo "GIT_VERSION_BRANCH=${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV
      - name: Install Python build dependencies
        run: python -m pip install build wheel octoprint --user
      - name: Building Python
        run: python -m build .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: |
            dist/*.whl
            dist/*.tar.gz

  test-e2e:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Cache node modules
        uses: actions/cache@v4
        env:
          cache-name: node-modules
        with:
          path: '**/node_modules'
          key: octodash-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            octodash-build-${{ env.cache-name }}-
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Install latest npm
        run: sudo npm install -g npm@latest
      - name: Installing Dependencies
        run: npm ci
      - name: Download artifacts
        uses: actions/download-artifact@v5
        with:
          name: build

      - name: Get Playwright version
        id: playwright-version
        run: |
          PLAYWRIGHT_VERSION=$(npm ls --json @playwright/test | jq --raw-output '.dependencies["@playwright/test"].version')
          echo "PLAYWRIGHT_VERSION=$PLAYWRIGHT_VERSION" >> $GITHUB_ENV

      - name: ðŸ§° Cache Playwright browser binaries
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: '~/.cache/ms-playwright'
          key: '${{ runner.os }}-playwright-playwright-${{ env.PLAYWRIGHT_VERSION }}'
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: ðŸ— Install Playwright browser binaries & OS dependencies
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          sudo rm -f /etc/apt/sources.list.d/microsoft-prod.list
          echo "::group::Installing Playwright browser binaries & OS dependencies"
          npx playwright install --with-deps
          echo "::endgroup::"

      - name: ðŸ— Install Playwright OS dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        shell: bash
        run: |
          sudo rm -f /etc/apt/sources.list.d/microsoft-prod.list
          echo "::group::Installing Playwright OS dependencies"
          npx playwright install-deps
          echo "::endgroup::"

      - name: Download artifact
        uses: actions/download-artifact@v5
        with:
          name: build

      - name: Setup Python environment
        run: |
          python -m pip install pytest octoprint --user
          python -m pip install *.whl --user
      
      - name: Setup OctoPrint config
        run: |
          mkdir -p ~/.octoprint
          cat > ~/.octoprint/users.yaml <<EOL
          _version: 2
          admin:
            active: true
            apikey: null
            groups:
            - admins
            - users
            password: $argon2id$v=19$m=65536,t=3,p=4$fQ8BwDgn5HwvxbgXAqA0Jg$/Dsj9oSSXvdccvwqblqMEYdUt+9mO8cKbGYdv/EGwY4
            permissions: []
            roles:
            - user
            - admin
            settings: {}
          EOL

      - name: Setup OctoPrint key
        run: |
          export OCTODOASH_API_KEY=$(openssl rand -hex 16)
          echo OCTODASH_API_KEY=$OCTODOASH_API_KEY >> .env.playwright
          mkdir -p ~/.octoprint/data/appkeys
          cat > ~/.octoprint/data/appkeys/keys.yaml <<EOF
          admin:
          - app_id: OctoDash
            api_key: $OCTODOASH_API_KEY
          EOF    
          cat ~/.octoprint/data/appkeys/keys.yaml
      - name: Run Playwright tests
        run: npx playwright test

      - name: â¬† Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          # name: playwright-report ${{ inputs.suffix }}
          name: playwright-report
          path: playwright-report

      - name: â¬† Upload OctoPrint logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: octoprint-logs
          path: ~/.octoprint/logs
  release:
    runs-on: ubuntu-latest

    if: github.event_name == 'release'
    needs: build
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Download artifacts
        uses: actions/download-artifact@v5
        with:
          name: build
      - name: Upload release
        env:
          GH_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
        run: gh release upload ${{ github.ref }} *.deb *.yml
